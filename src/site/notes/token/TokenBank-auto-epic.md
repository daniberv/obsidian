---
{"dg-publish":true,"permalink":"/token/token-bank-auto-epic/"}
---


## Работа с заявкой (epic)
- Клиент обращается в банк
- С ним создается tg-группа, в которую добавляется бот. Бот дает возможность запустить webapp
- Клиент или агент/менеджер через webapp заполняет клиентскую заявку на платеж
- Агент/менеджер проверяет корректность заполненной заявки. Редактирует по необходимости
- Агент/менеджер после проверки через webapp устанавливает статус заявки на "новая in-house заявка". В этот момент заявка обретает статус полноценной, но из-за особого флага эта заявка не отображается для всех агентов, а только лишь для нас самих (для нашего тенанта). В результате смены статуса для агента/менеджера показывается ссылка, ведущая на 1С на новую созданную заявку
- В результате установки статуса заявка попадает в 1С. Задача 1С сформировать удовлетворительные условия для заявки
- Внутри 1С операционист/менеджер подтверждает корректность данных и изменяет статус заявки на "в работе"
- Внутри ТГ-чата идет коммуникация, уточняются и корректируются детали по необходимости, документооборот
- Происходят промежуточные этапы (тестовый платеж, платеж клиентом, документооборот)
- Из 1С операционист/менеджер через UI генерирует документы (инвойсы, закрывашки, etc). Эти документы отправляются и в платформу и отображаются в ТГ-чате
- Генерацию документов может запросить менеджер из ТГ-чата (надо ли?)

 Что **клиент** может делать через webapp:
 - заполнить новую заявку
 - редактировать текущую заявку
 - изменить статус платежа заявки (отправил платеж)

Что **агент** может делать через webapp:
- заполнить новую заявку
- редактировать текущую заявку
- изменить статус заявки
- *заполнить предложение (пока недоступно, показываем readonly)*
- *генерировать 1С-документы (?)*

---
### Изменения для сущности тенанта (task_1 - 1-3 часа на безопасный рефактор текущей схемы)

Наш тенант (мастер-аккаунт) особый. На самом деле такой функциональности больше не будет ни у какого тенанта. Поэтому надо либо добавить для тенанта флаг "master" (название любое) или для заявок на уровне контроллеров и в создании учитывать, что если тенант такой-то, то его обрабатывать особо. Но лучше для чистоты и прозрачности изменить сущность тенанта и на уровне модели разветвлять логику. Суть этого флага - для заявок созданных этим тенантом и через API (это важно) не применимы обычные пайплайны. Возможен сценарий, что мы руками через UI создаем заявку, на которую, например, у нас нет своего агента. То есть "специальная заявка" - это только заявкка созданная через API (имею ввиду с каким-то флагом, например)

---
### Изменения для сущности заявки (task_2 - 1-3 часа на безопасный рефактор текущей схемы)

Заявки созданные из Телеграмма не должны проходить те же пайплайны, которые проходят заявки созданные через UI клиентского приложения. Вероятно для заявки надо добавить флаг, выделяющий ее особость - **"telegram_chat_id"**. Тут можно много чего надумать и сложно и интересно и масшабируемо, но у нас нет времени. Поэтому сейчас нам важно только иметь только прямое проперти, которое четко сразу говорит, что это заявка созданная через ТГ. Скорей всего это можно позже использовать и дальше для любого агента внутри ТГ (не только нас)
Тут же можно добавить **agent_id**, через который связывать валидного на изменения агента с этой заявкой

Особенности статуса **telegram_chat_id**
- заявка отображается для всех агентов без каких-либо особенностей, потому что в конечном счете мы принимаем свой же оффер. Пускай отображается для всех, создавая "живость" в таблицах на демках
- для заявки с этим статусом мы не применяем дедлайны и какие-либо пайплайны про время (пока что)
- для заявок с этим статусом мы применяем синхронизацию с ТГ-чатом (см выше общее описание)
- при создании заявки с особым статусом сразу прописываем и тем самым линкуем и агента через **agent_id**

---
### Изменения для сущности agent и offer (task_3 - 2-4 часа на рефакторинг текущей схемы и добавление пайплайна с авто-принятием)
- вероятно нужен какой-то вайтлист наших менеджеров (для агента как сущности надо добавить тоже **telegram_id**) и в рамках нашего приложения и в рамках webapp. Из заявки берем **agent_id** и, проверив его **telegram_id**, валидируем возможность агента/менеджера работать с заявкой
- оффер созданный верным агентом с валидным **agent_id** принимаем к заявке автоматически

---
### Интеграция с 1С (task_4 - 2-3 часа с нашей стороны)
При создании особой заявки сразу посылать ее в 1С для калькуляций. Внутри 1С с заявкой работает бухгалтер или агент и по готовности через UI формирует цифры по предложению. Результат работы - посланные данные в нашу платформу, которые мы должны "перевести" в предложение.
- надо сделать посылку данных заявки через api 1C (набор данных синкануть с 1С)
- надо дать для 1С ендпоинт, на который платформа получает данные, которые конвертирует и применяет к заявке, как принятое предложение
- надо дать для 1С ендпоинт, куда 1С посылает сгенерированные документы, которые мы сохраняем на платформе и показываем их у себя в чате и в ТГ-чате

---
### WebApp API (task_5 - 8-10 часов)
Надо добавить группу эндпоинтов для работы webapp с нашей платформой. Какие эндпоинты нужны:
1. Получение информации о юзере по **telegram_id** (имя, тенант, настройки, роль и права)
2. Получение заявки по **telegram_chat_id**
3. Создание и апдейт данных заявки по **telegram_chat_id**
4. Изменение статуса заявки по **telegram_chat_id**
5. Сохранение ассета/медиа-файла по **telegram_chat_id**
6. Сохранение сообщения по **telegram_chat_id**
7. Сохранение батчем всех сообщений чата по **telegram_chat_id**
9. *Получать информацию об очереди на генерацию документов (?)*
10. *Инициировать генерацию документов в 1С (?)*

---
### WebApp Frontend (task_6 - 4-8 часов на верстку включая биз-логику и деплой с ботом)
Нужно создать бота, которого агент руками добавляет в группу в клиентом. Бот дает webapp. Внутри webapp одно окно сразу с формой создания заявки. Когда заявка перешла из статуса "сбор предложений" (когда уже произошел авто-акцепт) - делаем все поля read-only. Плюс чуть разделяем - что показываем клиенту и что агенту (см выше общее описание).
Для агента показываем дополнительно форму предложения.

Возможности и задачи бота/webapp:
- авторизовывать открывающего через его Telegram ID
- на основании роли, полученной по его ID, иметь возможность показать разный контент и, в том числе, внутри контента иметь возможность менять функциональность
- создавать и редактировать заявки как со стороны клиента, так и со стороны агента

---

Отдельным эпиком автокомплиты и прочее